/* Chức năng sửa record */
<?php
	require "dbConnect.php";
	$mess = ""; // biến thông sửa thành công hay thất bại

	// Lây thông tin Record cần sửa
	if(empty($_GET['id'])){
		$id = "";
	}else{
		$id = $_GET['id'];
	}
	$stmtSel = $conn->prepare("SELECT * FROM tbcve WHERE id = ?");
	$stmtSel->bind_param("i", $id);
	$stmtSel->execute();
	$stmtSel->store_result();
	$stmtSel->bind_result($colId, $colTitle,  $colCve, $colOsvdb, $colAuthor, $colPublished, $colImpact, $colPlatform, $colFile, $colUrl);
	$stmtSel->fetch();
	$stmtSel->close();


	if ($_SERVER["REQUEST_METHOD"] == "POST") {
		$title = filter_var($_POST['title'], FILTER_SANITIZE_STRING); // xử dụng filter để vệ sinh dữ liệu đầu vào
		$CVE = filter_var($_POST['cve'], FILTER_SANITIZE_STRING);// FILTER_SANITIZE_STRING xóa các kí tự <> </>
		$OSVDB = filter_var($_POST['osvdb'], FILTER_SANITIZE_STRING);
		$author = filter_var($_POST['author'], FILTER_SANITIZE_STRING);
		$published = filter_var($_POST['published'], FILTER_SANITIZE_STRING);
		$impact = filter_var($_POST['impact'], FILTER_SANITIZE_STRING);
		$platform = filter_var($_POST['platform'], FILTER_SANITIZE_STRING);
		$file = filter_var($_POST['file'], FILTER_SANITIZE_STRING);
		$url = filter_var($_POST['url'], FILTER_SANITIZE_STRING);
		$id= filter_var($_POST['id'], FILTER_VALIDATE_INT);

		$sql = "UPDATE tbcve SET title=?, CVE=?, OSVDB=?, author=?, published=?, impact=?, platform=?, file=?, url=? WHERE id=?";
			// Tạo đối tượng prepared
		$stmtUpd = $conn->prepare($sql);
		// Gán các giá trị vào các tham số ẩn
		$stmtUpd->bind_param("sssssssssi", $title, $CVE, $OSVDB, $author, $published, $impact, $platform, $file, $url, $id);
		$stmtUpd->execute();
		if($stmtUpd->affected_rows > 0){
			$mess = "Record was updated successfully";
		}else{
			$mess = "Update failed";
		}
	}
?>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Exploit Knowledge-Based</title>
	<link href="./public/css/style.css" rel="stylesheet" type="text/css">
</head>
<body>
<div class="left">
	<h2>Exploit Knowledge-Based</h2>
</div>
<div class="right">	
	<h1>Hello</h1>
	<div class="header-menu">
		<a href="index.php"><h4>HOME</h4></a>
	</div>
	<div class="edit"><h2>Edit CVE</h2>
		<form action="<?php echo $_SERVER["PHP_SELF"];?>" method="post">
		<input type="text" name="id" placeholder="ID" value="<?php echo $colId; ?>">
		<input type="text" name="title" placeholder="Title" value="<?php echo $colTitle; ?>">
		<input type="text" name="cve" placeholder="CVE" value="<?php echo $colCve; ?>">
		<input type="text" name="osvdb" placeholder="OSVDB" value="<?php echo $colOsvdb; ?>">
		<button type="submit">Edit</button><br>
		<input type="text" name="published" placeholder="Published" value="<?php echo $colPublished; ?>">	
		<input type="text" name="author" placeholder="Author" value="<?php echo $colAuthor; ?>">
		<input type="text" name="impact" placeholder="Impact" value="<?php echo $colImpact; ?>">
		<input type="text" name="platform" placeholder="Platform"  value="<?php echo $colPlatform; ?>">		
		<button type="reset">Reset</button><br>
		<input type="text" name="file" placeholder="File" value="<?php echo $colFile; ?>">
		<input type="text" name="url" placeholder="Url" value="<?php echo $colUrl; ?>">	
		</form>

		<b><?php echo $mess; ?></b>
	</div>

</div>	
</body>
</html>

<?php
	//$stmt->close();
	//$conn->close();

?>