/* Chức năng tìm kiếm record */
<?php
	require "dbConnect.php";
	if(empty($_GET['page'])){	//lấy số trang hiện tại 
	$page = 1;
	}else{
	$page = $_GET['page']; 
	}
	$n = 100; // Số tin trên trang
	$fromRecord = ($page - 1)*$n;

	if(isset($_REQUEST['title'])){
		$title = "%".$_REQUEST['title']."%";
	}else{
		$title = "%%";
	}
	if(isset($_REQUEST['cve'])){
		$cve = "%".$_REQUEST['cve']."%";
	}else{
		$cve = "%%";
	}
 	if(isset($_REQUEST['osvdb'])){
 		$osvdb = "%".$_REQUEST['osvdb']."%";
 	}else{
 		$osvdb = "%%";
 	}
 	if(isset($_REQUEST['author'])){
 		$author = "%".$_REQUEST['author']."%";
 	}else{
 		$author = "%%";
 	}
 	if(isset($_REQUEST['published'])){
 		$published = "%".$_REQUEST['published']."%";
 	}else{
 		$published = "%%";
 	}
 	if(isset($_REQUEST['impact'])){
 		$impact = "%".$_REQUEST['impact']."%"; 
 	}else{
 		$impact = "%%";
 	}
 	if(isset($_REQUEST['platform'])){
 		$platform = "%".$_REQUEST['platform']."%";
 	}else{
 		$platform = "%%";
 	}
 	
 	
 	$sql = "SELECT * FROM tbcve WHERE title LIKE ? AND CVE LIKE ? AND osvdb LIKE ? AND author LIKE ? AND published LIKE ? AND impact LIKE ? AND platform LIKE ? LIMIT ?, ?";
 	$stmt= $conn->prepare($sql);
 	$stmt->bind_param("sssssssss", $title, $cve, $osvdb, $author, $published, $impact, $platform, $fromRecord, $n);
	 
	//$title = "%%";
	$stmt->execute(); 
	$stmt->bind_result($colId, $colTitle,  $colCve, $colOsvdb, $colAuthor, $colPublished, $colImpact, $colPlatform, $colFile, $colUrl);
	
	$stmt->store_result();

 
	$sql2 = "SELECT * FROM tbcve WHERE title LIKE ? AND CVE LIKE ? AND osvdb LIKE ? AND author LIKE ? AND published LIKE ? AND impact LIKE ? AND platform LIKE ?";
 	$stmt2= $conn->prepare($sql2);
 	$stmt2->bind_param("sssssss", $title, $cve, $osvdb, $author, $published, $impact, $platform);
	$stmt2->execute(); 
	$stmt2->store_result();
	$numRecord = $stmt2->num_rows;
	$numPages = ceil($numRecord / $n);

	//header("location:searchView.php");
?>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Exploit Knowledge-Based</title>
	<link href="./public/css/style.css" rel="stylesheet" type="text/css">
</head>
<body>
<div class="left">
	<h2>Exploit Knowledge-Based- search</h2>
</div>
<div class="right">	
	<div class="header-menu">
		<a href="index.php"><h4>HOME</h4></a>
	</div>
	<div class="search"><h2>Advanced Search</h2>
		<form action="<?php echo $_SERVER["PHP_SELF"];?>" method="get">
		<input type="text" name="title" placeholder="Title">
		<input type="text" name="cve" placeholder="CVE">
		<input type="text" name="osvdb" placeholder="OSVDB">
		<button type="submit">Search</button><br>
		<input type="text" name="published" placeholder="Published">
		<input type="text" name="author" placeholder="Author">
		<input type="text" name="impact" placeholder="Impact">	
		<button type="reset">Reset</button><br>
		<input type="text" name="platform" placeholder="Platform">	
		</form>
	</div>
	<div class="show">
		<table>
			<div class="title">
				<tr>								
					<th>CVE-ID</th>
					<th>Title</th>
					<th>CVE</th>
					<th>OSVDB</th>
					<th>Author</th>
					<th>Published</th>
					<th>Impact</th>
					<th>Platform</th>
					<th>File</th>
					<th>Url</th>
					<th>.</th>
					<th>.</th>
					<th>.</th>
				</tr>
			</div>
			<div class="content">
				<?php
					if($stmt->num_rows > 0){
						
						while($stmt->fetch()) {
        		
        		?>
				<tr>
					<td width="5%"><?php echo $colId ?></td>
					<td width="26%"><?php echo $colTitle ?></td>
					<td width="7%"><?php echo $colCve ?></td>
					<td width="7%"><?php echo $colOsvdb ?></td>
					<td width="8%"><?php echo $colAuthor ?></td>
					<td width="8%"><?php echo $colPublished ?></td>
					<td width="8%"><?php echo $colImpact ?></td>
					<td width="8%"><?php echo $colPlatform ?></td>
					<td width="5%"><?php echo $colFile ?></td>
					<td width="8%"><?php echo $colUrl ?></td>
					<td><a href="update.php?id=<?php echo $colId?>"><img src="./public/image/edit.png"></a></td>
					<td><a href="delete.php?id=<?php echo $colId?>"><img src="./public/image/delete.png"></a></td>
					<td><a href="export.php?id=<?php echo $colId?>"><img src="./public/image/export.png"></a></td>
				</tr>
        		<?php
    					}
    		
					}
	
				?>
			</div>
			 
		</table>
		<div class="footer">
				<?php
					for($page=1; $page<=$numPages; $page++){
						echo "<a href='search.php?page=$page'>$page</a> - ";
					}
					echo "<i>",$numRecord," resurlt</i>";
				?>
		</div>
	</div>
</div>
</body>
</html>
<?php
	$stmt->close();
	$stmt2->close();
	$conn->close();

?>